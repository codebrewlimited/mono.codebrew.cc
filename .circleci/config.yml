version: 2.1

orbs:
  node: circleci/node@5.0

executors:
  node-executor:
    docker:
      - image: cimg/node:22.16
    working_directory: ~/repo

jobs:
  detect-changes:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Fetch main and full history
          command: |
            git fetch origin main --depth=1 || true
            git fetch --unshallow || true

      - run:
          name: Detect changes since base
          command: |
            echo "üîç Detecting changes..."

            # Determine base commit for diff
            if [ -n "$CIRCLE_PULL_REQUEST" ]; then
              BASE_BRANCH="origin/main"
              echo "PR detected. Comparing against $BASE_BRANCH"
            elif [ "$CIRCLE_BRANCH" = "main" ]; then
              BASE_BRANCH="HEAD~1"
              echo "Main branch build. Comparing last commit only"
            else
              BASE_BRANCH="origin/main"
              echo "Feature branch detected. Comparing against $BASE_BRANCH"
            fi

            # Exclude any file named CHANGELOG.md but always include package.json
            CHANGED_FILES=$(git diff --name-only $BASE_BRANCH...HEAD | grep -v -E "CHANGELOG.md|package.json" || echo "")

            if git diff --name-only $BASE_BRANCH...HEAD | grep -q "package.json"; then
              CHANGED_FILES="$CHANGED_FILES"$'\n'"package.json"
            fi

            echo "Changed files (filtered):"
            echo "$CHANGED_FILES"

            if echo "$CHANGED_FILES" | grep -qE "^v1/"; then
              echo "V1_CHANGED=true" >> workspace-vars
            else
              echo "V1_CHANGED=false" >> workspace-vars
            fi

            if echo "$CHANGED_FILES" | grep -qE "^v2/"; then
              echo "V2_CHANGED=true" >> workspace-vars
            else
              echo "V2_CHANGED=false" >> workspace-vars
            fi

            echo "workspace-vars created:"
            cat workspace-vars

      - persist_to_workspace:
          root: .
          paths:
            - workspace-vars

  build-and-test:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo

      - run:
          name: Load workspace vars
          command: |
            if [ -f workspace-vars ]; then
              source workspace-vars
            fi
            echo "V1_CHANGED=$V1_CHANGED"
            echo "V2_CHANGED=$V2_CHANGED"

      - run:
          name: Skip if no app changed
          command: |
            source workspace-vars
            if [ "$V1_CHANGED" = "false" ] && [ "$V2_CHANGED" = "false" ]; then
              echo "No app changes detected ‚Äî skipping build and tests. üí§"
              exit 0
            fi

      - run:
          name: Install root dependencies
          command: npm ci

      - run:
          name: Build test targets
          command: |
            source workspace-vars
            if [ "$V1_CHANGED" = "false" ]; then
              echo "üèóÔ∏è Building v1"
              cd v1
              npm ci
              npm run build
              cd ..
            fi

            if [ "$V2_CHANGED" = "true" ]; then
              echo "üèóÔ∏è Building v2"
              cd v2
              npm ci
              npm run build
              cd ..
            fi

      - run:
          name: Run tests
          command: npm test --workspaces

  release-and-build:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo

      - run:
          name: Load workspace vars
          command: |
            if [ -f workspace-vars ]; then
              source workspace-vars
            fi
            echo "V1_CHANGED=$V1_CHANGED"
            echo "V2_CHANGED=$V2_CHANGED"

      - run:
          name: Install root dependencies
          command: npm ci

      - run:
          name: Conditional release
          command: |
            source workspace-vars
            git config --global user.email "ci-bot@codebrew.cc"
            git config --global user.name "CI Bot"

            if [ "$V1_CHANGED" = "true" ]; then
              echo "üì¶ Running release for v1"
              npm run version:v1
            fi
            if [ "$V2_CHANGED" = "true" ]; then
              echo "üì¶ Running release for v2"
              npm run version:v2
            fi

      - run:
          command: git push --follow-tags --no-verify
          environment:
            HUSKY: 0
      - run:
          name: Install rsync
          command: sudo apt-get update && sudo apt-get install -y rsync

      - run:
          name: Install AWS CLI
          command: |
            # 1- Install AWS CLI
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
            aws --version

      - run:
          name: Configure AWS Credentials
          command: |
            source workspace-vars

            mkdir -p ~/.aws
            printf "[default]\naws_access_key_id=$AWS_ACCESS_KEY_ID\naws_secret_access_key=$AWS_SECRET_ACCESS_KEY\nregion=$AWS_DEFAULT_REGION\n" > ~/.aws/credentials

      - run:
          name: Test AWS
          command: aws sts get-caller-identity

      - run:
          name: Build & Deploy (SSH Deploy)
          command: |
            source workspace-vars

            # 1- Get the public IP of the current CircleCI runner
            PUBLIC_IP=$(curl ipinfo.io/ip)

            # 2- Add an ingress rule to the security group
            aws ec2 authorize-security-group-ingress --region $AWS_DEFAULT_REGION --group-id $SG_ID \
              --protocol tcp --port 22 --cidr $PUBLIC_IP/24

            # 3- Give the ingress rule some time to propogate
            sleep 5

            # 4- SSH to the server to deploy
            if [ "$V1_CHANGED" = "true" ]; then
              echo "üöÄ Deploying v1 over SSH"

              ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST '
                set -e  # fail fast

                cd /var/api/test.codebrew.cc

                echo "üì¶ Pulling latest code..."
                git fetch origin main
                git reset --hard origin/main
                
                echo "üì¶ Installing dependencies..."
                cd v1
                npm i

                echo "üèóÔ∏è Building project..."
                npm run build

                echo "üöÄ Restarting app..."
                pwd
                pm2 restart test.codebrew.cc/v1 --update-env || pm2 start dist/main.js --name v1
              '
            fi


            # rsync -avz --delete \
            #   -e "ssh -o StrictHostKeyChecking=no" \
            #   ./v1/ $SSH_USER@$SSH_HOST:/var/api/test.codebrew.cc/v1/

            # 5- Remove the ingress rule
            aws ec2 revoke-security-group-ingress --region $AWS_DEFAULT_REGION --group-id $SG_ID --protocol tcp --port 22 --cidr $PUBLIC_IP/24

workflows:
  version: 2
  build-and-release:
    jobs:
      - detect-changes

      - build-and-test:
          requires:
            - detect-changes
          filters:
            branches:
              only: main

      - release-and-build:
          requires:
            - build-and-test
          filters:
            branches:
              only: main
