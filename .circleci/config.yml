version: 2.1
jobs:
  release:
    docker:
      - image: cimg/node:22.18
    steps:
      - checkout
      - run: npm ci
      - run:
          name: Update package list ðŸ“¦ðŸ”„
          command: npm install --force
      - run:
          name: Configure Git
          command: |
            git config --global user.name "CI Bot"
            git config --global user.email "ci-bot@example.com"
      - run:
          name: Build, deploy, Release `v1` if changed
          command: |
            if git diff --name-only HEAD~1 | grep -q "^v1/"; then
              cd v1
              npm run build --workspace v1
              npx standard-version --no-verify --message "chore(release): %s [skip ci]"
              # scp -r v1 ec2-user@<EC2-IP>:/home/ec2-user/app
              # ssh ec2-user@<EC2-IP> "cd /home/ec2-user/app && npm install --production && pm2 restart all"
              cd ..
            fi
      - run:
          name: Release v2 if changed
          command: |
            if git diff --name-only HEAD~1 | grep -q "^v2/"; then
              cd v2
              npx standard-version
              cd ..
            fi
      - run:
          name: Push release
          command: git push --follow-tags --no-verify
          environment:
            HUSKY: 0
workflows:
  version: 2
  release-workflow:
    jobs:
      - release
