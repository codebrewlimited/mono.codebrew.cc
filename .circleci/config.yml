# version: 2.1
# jobs:
#   release:
#     docker:
#       - image: cimg/node:22.18
#     steps:
#       - checkout
#       - run: npm ci
#       - run:
#           name: Update package list ðŸ“¦ðŸ”„
#           command: npm install --force
#       - run:
#           name: Configure Git
#           command: |
#             git config --global user.name "CI Bot"
#             git config --global user.email "ci-bot@example.com"
#       - run:
#           name: Build, deploy, Release `v1` if changed
#           command: |
#             if git diff --name-only HEAD~1 | grep -q "^v1/"; then
#               cd v1
#               npm run build
#               npx standard-version --no-verify --message "chore(release): %s [skip ci]"
#               # scp -r v1 ec2-user@<EC2-IP>:/home/ec2-user/app
#               # ssh ec2-user@<EC2-IP> "cd /home/ec2-user/app && npm install --production && pm2 restart all"
#               cd ..
#             fi
#       - run:
#           name: Release v2 if changed
#           command: |
#             if git diff --name-only HEAD~1 | grep -q "^v2/"; then
#               cd v2
#               npx standard-version
#               cd ..
#             fi
#       - run:
#           name: Push release
#           command: git push --follow-tags --no-verify
#           environment:
#             HUSKY: 0
# workflows:
#   version: 2
#   release-workflow:
#     jobs:
#       - release

version: 2.1

jobs:
  check_v1_changes:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Detect changes in v1
          command: |
            git fetch --tags
            if git diff --quiet $(git describe --tags --abbrev=0) HEAD -- v1/; then
              echo "no_changes=true" >> $BASH_ENV
              echo "ðŸŸ¡ No changes detected in v1, skipping build/deploy."
            else
              echo "no_changes=false" >> $BASH_ENV
              echo "âœ… Changes detected in v1, proceeding to build/deploy."
            fi
      - persist_to_workspace:
          root: .
          paths:
            - .

  build_and_test_v1:
    docker:
      - image: cimg/node:22.3
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Check if v1 changed
          command: |
            source $BASH_ENV || true
            if [ "$no_changes" = "true" ]; then
              echo "Skipping build/test for v1."
              circleci step halt
            fi
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Configure Git
          command: |
            git config --global user.name "CI Bot"
            git config --global user.email "ci-bot@circleci.com"
            git config --global url."https://${GH_TOKEN}@github.com/".insteadOf "https://github.com/"
      # - run:
      #     name: Build v1
      #     command: npm run build --workspace v1
      - run:
          name: Run tests for v1
          command: npm run test --workspace v1
      - persist_to_workspace:
          root: .
          paths:
            - v1
      - run:
          name: Versioning
          command: |
            npx standard-version --no-verify --message "chore(release): %s [skip ci]"
      - run:
          name: Push release
          command: git push --follow-tags --no-verify
          environment:
            HUSKY: 0

  deploy_v1:
    docker:
      - image: cimg/node:22.3
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Check if v1 changed
          command: |
            source $BASH_ENV || true
            if [ "$no_changes" = "true" ]; then
              echo "Skipping deploy for v1."
              circleci step halt
            fi
      - run:
          name: Deploy v1 to EC2
          command: |
            echo "ðŸš€ Deploying v1 to EC2..."
            scp -o StrictHostKeyChecking=no -r v1 ec2-user@${EC2_HOST}:/home/ec2-user/app
            ssh -o StrictHostKeyChecking=no ec2-user@${EC2_HOST} "
              cd /home/ec2-user/app &&
              npm ci --omit=dev &&
              pm2 reload all || pm2 start dist/main.js --name v1-api
            "

  build_and_push_docker:
    docker:
      - image: cimg/node:20.9
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Docker image
          command: |
            VERSION=$(node -p "require('./v1/package.json').version")
            docker build -t codebrew/v1:$VERSION -f Dockerfile .
      - run:
          name: Push Docker image
          command: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
            VERSION=$(node -p "require('./v1/package.json').version")
            docker push codebrew/v1:$VERSION
      - persist_to_workspace:
          root: .
          paths:
            - v1

  deploy_v1_docker:
    docker:
      - image: cimg/base:stable
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Deploy v1 Docker container on EC2
          command: |
            VERSION=$(node -p "require('./v1/package.json').version")
            ssh -o StrictHostKeyChecking=no ec2-user@${EC2_HOST} "
              docker pull codebrew/v1:$VERSION &&
              docker stop v1 || true &&
              docker rm v1 || true &&
              docker run -d --name v1 -p 80:3000 codebrew/v1:$VERSION
            "

workflows:
  version: 2
  build_test_deploy_v1:
    jobs:
      - check_v1_changes
      - build_and_test_v1:
          requires:
            - check_v1_changes
      - build_and_push_docker:
          requires:
            - build_and_test_v1
      - deploy_v1_docker:
          requires:
            - build_and_push_docker
