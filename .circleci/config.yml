version: 2.1

orbs:
  node: circleci/node@5.0

executors:
  node-executor:
    docker:
      - image: cimg/node:22.16
    working_directory: ~/repo

jobs:
  detect-changes:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Fetch main and full history
          command: |
            git fetch origin main --depth=1 || true
            git fetch --unshallow || true

      - run:
          name: Detect changes since base
          command: |
            echo "üîç Detecting changes..."

            # Determine base commit for diff
            if [ -n "$CIRCLE_PULL_REQUEST" ]; then
              BASE_BRANCH="origin/main"
              echo "PR detected. Comparing against $BASE_BRANCH"
            elif [ "$CIRCLE_BRANCH" = "main" ]; then
              BASE_BRANCH="HEAD~1"
              echo "Main branch build. Comparing last commit only"
            else
              BASE_BRANCH="origin/main"
              echo "Feature branch detected. Comparing against $BASE_BRANCH"
            fi

            CHANGED_FILES=$(git diff --name-only $BASE_BRANCH...HEAD || echo "")
            echo "Changed files:"
            echo "$CHANGED_FILES"

            if echo "$CHANGED_FILES" | grep -qE "^v1/"; then
              echo "‚úÖ Detected changes in v1"
              echo "V1_CHANGED=true" >> workspace-vars
            else
              echo "‚ÑπÔ∏è No changes in v1"
              echo "V1_CHANGED=true" >> workspace-vars
            fi

            if echo "$CHANGED_FILES" | grep -qE "^v2/"; then
              echo "‚úÖ Detected changes in v2"
              echo "V2_CHANGED=true" >> workspace-vars
            else
              echo "‚ÑπÔ∏è No changes in v2"
              echo "V2_CHANGED=false" >> workspace-vars
            fi

            echo "workspace-vars created:"
            cat workspace-vars

      - persist_to_workspace:
          root: .
          paths:
            - workspace-vars

  release-and-build:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Load workspace vars
          command: |
            if [ -f workspace-vars ]; then
              source workspace-vars
            fi
            echo "V1_CHANGED=$V1_CHANGED"
            echo "V2_CHANGED=$V2_CHANGED"

      - run:
          name: Install dependencies
          command: npm ci

      - run:
          name: Conditional release
          command: |
            source workspace-vars
            git config --global user.email "ci-bot@codebrew.cc"
            git config --global user.name "CI Bot"

            if [ "$V1_CHANGED" = "true" ]; then
              echo "üì¶ Running release for v1"
              npm run version:v1
            fi
            if [ "$V2_CHANGED" = "true" ]; then
              echo "üì¶ Running release for v2"
              npm run version:v2
            fi
      - run:
          command: git push --follow-tags --no-verify
          environment:
            HUSKY: 0

      # - run:
      #     name: Build Docker images
      #     command: |
      #       source workspace-vars
      #       if [ "$V1_CHANGED" = "true" ]; then
      #         echo "üê≥ Building Docker image for v1"
      #         docker build -f Dockerfile -t myregistry/my-app:v1-$CIRCLE_SHA1 --build-arg WORKSPACE=v1 .
      #       fi
      #       if [ "$V2_CHANGED" = "true" ]; then
      #         echo "üê≥ Building Docker image for v2"
      #         docker build -f Dockerfile -t myregistry/my-app:v2-$CIRCLE_SHA1 --build-arg WORKSPACE=v2 .
      #       fi

      # - run:
      #     name: Push Docker images
      #     command: |
      #       echo $REGISTRY_PASS | docker login $REGISTRY_URL -u $REGISTRY_USER --password-stdin

      #       if [ "$V1_CHANGED" = "true" ]; then
      #         docker build -f Dockerfile -t $REGISTRY_URL/monorepo/v1:$CIRCLE_SHA1 --build-arg WORKSPACE=v1 .
      #         docker push $REGISTRY_URL/monorepo/v1:$CIRCLE_SHA1
      #       fi

      #       if [ "$V2_CHANGED" = "true" ]; then
      #         docker build -f Dockerfile -t $REGISTRY_URL/monorepo/v2:$CIRCLE_SHA1 --build-arg WORKSPACE=v2 .
      #         docker push $REGISTRY_URL/monorepo/v2:$CIRCLE_SHA1
      #       fi

      - run:
          name: Build & Push Docker images
          command: |
            source workspace-vars
            echo $REGISTRY_PASS | docker login $REGISTRY_URL -u $REGISTRY_USER --password-stdin

            if [ "$V1_CHANGED" = "true" ]; then
              echo "üê≥ Building and pushing Docker image for v1"
              docker build -f Dockerfile \
                -t $REGISTRY_URL/monorepo/v1:$CIRCLE_SHA1 \
                --build-arg WORKSPACE=v1 .
              docker push $REGISTRY_URL/monorepo/v1:$CIRCLE_SHA1
            fi

            if [ "$V2_CHANGED" = "true" ]; then
              echo "üê≥ Building and pushing Docker image for v2"
              docker build -f Dockerfile \
                -t $REGISTRY_URL/monorepo/v2:$CIRCLE_SHA1 \
                --build-arg WORKSPACE=v2 .
              docker push $REGISTRY_URL/monorepo/v2:$CIRCLE_SHA1
            fi

workflows:
  version: 2
  build-and-release:
    jobs:
      - detect-changes
      - release-and-build:
          requires:
            - detect-changes
          filters:
            branches:
              only: main
