
version: 2.1
orbs:
  node: circleci/node@5.0.2

jobs:
  release:
    docker:
      - image: cimg/node:22.18
    environment:
      # Provide a token via CircleCI project settings: e.g. RELEASE_PLEASE_TOKEN
      # For GitHub, set GITHUB_TOKEN; for Bitbucket, configure an app password and use appropriate flags.
      GIT_USER: "circleci-release-bot"
      GIT_EMAIL: "circleci@example.com"
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Install release-please CLI
          command: |
            npm ci
            npm install -g @google/release-please-cli
      - run:
          name: Release v1
          command: |
            echo "Running release-please for v1..."
            # NOTE: release-please primarily targets GitHub. For Bitbucket, additional setup is required.
            # This command will create a release PR; to auto-commit in CI you may adjust flags or use a token with
            # permissions. Replace --token with $RELEASE_PLEASE_TOKEN in CircleCI project env vars.
            npx release-please release-pr --path v1 --package-name v1 --token "${RELEASE_PLEASE_TOKEN}" || true
      - run:
          name: Release v2
          command: |
            echo "Running release-please for v2..."
            npx release-please release-pr --path v2 --package-name v2 --token "${RELEASE_PLEASE_TOKEN}" || true

workflows:
  release_workflow:
    jobs:
      - release:
          filters:
            branches:
              only: master
