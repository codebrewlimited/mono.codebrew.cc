version: 2.1

orbs:
  node: circleci/node@5.0

executors:
  node-executor:
    docker:
      - image: cimg/node:22.16
    working_directory: ~/repo

jobs:
  detect-changes:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Detect changed workspaces
          command: |
            echo "ðŸ” Detecting changes since origin/main..."

            # List changed files
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD || echo "")

            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Detect v1 changes
            if echo "$CHANGED_FILES" | grep -qE "^v1/"; then
              echo "âœ… Detected changes in v1"
              echo "V1_CHANGED=true" >> $BASH_ENV
            else
              echo "â„¹ï¸ No changes in v1"
              echo "V1_CHANGED=false" >> $BASH_ENV
            fi

            # Detect v2 changes
            if echo "$CHANGED_FILES" | grep -qE "^v2/"; then
              echo "âœ… Detected changes in v2"
              echo "V2_CHANGED=true" >> $BASH_ENV
            else
              echo "â„¹ï¸ No changes in v2"
              echo "V2_CHANGED=false" >> $BASH_ENV
            fi

  release-and-build:
    executor: node-executor
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: npm ci
      - run:
          name: Conditional release
          command: |
            if [ "$V1_CHANGED" = "true" ]; then
              npm run release:v1
            fi
            if [ "$V2_CHANGED" = "true" ]; then
              npm run release:v2
            fi
      - run:
          name: Build Docker images
          command: |
            if [ "$V1_CHANGED" = "true" ]; then
              docker build -f Dockerfile -t myregistry/my-app:v1-$CIRCLE_SHA1 --build-arg WORKSPACE=v1 .
            fi
            if [ "$V2_CHANGED" = "true" ]; then
              docker build -f Dockerfile -t myregistry/my-app:v2-$CIRCLE_SHA1 --build-arg WORKSPACE=v2 .
            fi
      - run:
          name: Push Docker images
          command: |
            if [ "$V1_CHANGED" = "true" ]; then
              docker push myregistry/my-app:v1-$CIRCLE_SHA1
            fi
            if [ "$V2_CHANGED" = "true" ]; then
              docker push myregistry/my-app:v2-$CIRCLE_SHA1
            fi

workflows:
  version: 2
  build-and-release:
    jobs:
      - detect-changes
      - release-and-build:
          requires:
            - detect-changes
          filters:
            branches:
              only: main
